<!DOCTYPE html>
<html>
	<head lang="zh">
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="renderer" content="webkit" />
		<meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=0" />
		<title>Luckysheet</title>
		<link rel="stylesheet" href="./plugins/css/pluginsCss.css" />
		<link rel="stylesheet" href="./plugins/plugins.css" />
		<link rel="stylesheet" href="./css/luckysheet.css" />
		<link rel="stylesheet" href="./assets/iconfont/iconfont.css" />
		<script src="./plugins/js/plugin.js"></script>

		<!-- rollup luckysheet.js -->
		<script src="./luckysheet.umd.js"></script>
		<script src="./demoData/sheetVchart.js"></script>
		<script src="./demoData/sheetChart.js"></script>
		<script src="./demoData/sheetCell.js"></script>
		<script src="./demoData/sheetPicture.js"></script>
	</head>

	<body>
		<div id="luckysheet" style="margin: 0px; padding: 0px; position: absolute; width: 100%; height: 100%; left: 0px; top: 0px"></div>

		<script>
			// 公共配置项
			const commonOptions = {
				container: "luckysheet",
				lang: "zh",
				// showinfobar: false, // 隐藏信息栏
				plugins: ["fileImport", "vchart", "chart"],
				data: [sheetCell],

				// 自定义请求头
				// requestHeaders: {
				// 	"Custom-userid": "123",
				// },

				// 自定义右键菜单
				cellRightClickConfig: {
					customs: [
						{
							title: "test",
							onClick: function (clickEvent, event, params) {
								console.log("function test click", clickEvent, event, params);
							},
						},
					],
				},

				// 项目菜单
				menuHandler: {
					// 隐藏内置菜单
					// hideDefaultMenu: ['exportFile', 'importFile'],
					// 自定义
					customs: [
						// 分割线
						{
							order: 0,
							label: "自定义菜单",
							value: "newFile",
							callback: () => {
								console.log("==> 自定义菜单");
							},
						},
						{
							order: 0,
							value: "divider",
						},
					],
				},

				// loading 样式
				loading: {
					image: () => {
						return `<svg viewBox="25 25 50 50" class="circular">
						<circle cx="50" cy="50" r="20" fill="none"></circle>
						</svg>`;
					},
					imageClass: "loadingAnimation",
				},
			};

			// 动态获取 luadUrl
			function getLoadUrl(currentBranch, gridkey) {
				return `http://localhost:9000${currentBranch === "master-alpha" ? "/" : "/luckysheet/"}loadSheetData?gridkey=${gridkey}`;
			}

			// 动态获取 updateUrl
			function getUpdateUrl(currentBranch, userid, username, gridkey) {
				return `ws://localhost:9000
				${currentBranch === "master-alpha" ? "?" : "/luckysheet?"}
				type=luckysheet&userid=${userid}&username=${username}&gridkey=${gridkey}`;
			}

			$(function () {
				/**
				 * -------------------------------------------------------
				 * ⚠️ 注意：请严格按照下列步骤进行配置，否则会导致无法协同 ⚠️
				 * -------------------------------------------------------
				 */

				// 1. 请明确 `luckysheet-crdt` 项目目前所在的分支，因为 master-alpha 与 master-vue 分支所在的服务端不尽相同，`master-vue` 分支需要校验 token
				const currentBranch = "master-vue"; // "master-vue" | "master-alpha"

				// 2. 定义 userid 内部 userid 可随机生成
				const userid = Math.random().toString(16).slice(2, 8);

				// 3. username 字段 仅用于显示 xxx正在编辑
				const username = `user_${userid}`;

				// 4. 这个是协同的文件 gridKey 请真实的设置为数据库的 key，不然会提示协同服务异常 是真实数据库表的 workerbooks gridKey 字段
				const gridkey = "705abf334c946bf5545ce04f586eb42e";

				// 5. 配置协同，请打开下列三项配置，并确保配置正确的 gridKey
				const options = Object.assign({}, commonOptions, {
					// 如果是 master-vue 的话，还需要添加自定义请求头，请检查合并属性哈，不然容易遗漏属性
					requestHeaders: {
						"enable-pass-token": currentBranch === "master-vue" ? true : false, // 是否允许跳过 token 验证
					},
					allowUpdate: true, // 配置协同功能
					loadUrl: getLoadUrl(currentBranch, gridkey),
					updateUrl: getUpdateUrl(currentBranch, userid, username, gridkey), // 协同服务转发服务
				});

				// 6. 创建表格
				luckysheet.create(options);
			});
		</script>
	</body>
</html>
